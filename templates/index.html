<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>TDFC Dico</title>

  <!-- Apple PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="TDFC Dico">
  <link rel="apple-touch-icon" href="/static/icon.png">

  <style>
    :root{
      --bg: #f2f2f7;
      --card: rgba(255,255,255,0.82);
      --text: #111;
      --muted: rgba(60,60,67,0.72);
      --border: rgba(60,60,67,0.16);
      --field: rgba(255,255,255,0.75);
      --result: rgba(255,255,255,0.9);
      --shadow: 0 12px 40px rgba(0,0,0,0.10);
      --accent: #007aff;
      --accentPressed: #0062cc;
      --danger: #ff3b30;
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg: #000;
        --card: rgba(28,28,30,0.70);
        --text: #f5f5f7;
        --muted: rgba(235,235,245,0.65);
        --border: rgba(235,235,245,0.14);
        --field: rgba(44,44,46,0.80);
        --result: rgba(44,44,46,0.85);
        --shadow: 0 16px 50px rgba(0,0,0,0.55);
        --accent: #0a84ff;
        --accentPressed: #006fe6;
      }
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: -apple-system, system-ui, sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(0,122,255,0.22), transparent 55%),
                  radial-gradient(1000px 600px at 110% 20%, rgba(255,45,85,0.18), transparent 60%),
                  radial-gradient(900px 500px at 40% 120%, rgba(52,199,89,0.16), transparent 60%),
                  var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    .wrap{
      max-width: 640px;
      margin: 0 auto;
      padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom) 16px;
    }

    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 22px 6px 10px 6px;
    }

    .title{
      display:flex; flex-direction:column; gap:4px;
    }
    .title h1{
      margin:0; font-size: 28px; line-height: 1.1; letter-spacing: -0.02em;
    }
    .title .sub{
      font-size: 13px; color: var(--muted);
    }

    .pill{
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      color: var(--muted);
    }

    .card{
      margin: 10px 0 18px 0;
      padding: 16px;
      border-radius: 18px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      transform: translateY(6px);
      opacity: 0;
      animation: cardIn 520ms cubic-bezier(.2,.8,.2,1) forwards;
    }

    @keyframes cardIn{
      to { transform: translateY(0); opacity: 1; }
    }

    .row{
      display:flex;
      gap: 10px;
      margin-top: 10px;
    }
    .row > *{ flex: 1; }

    input{
      width:100%;
      padding: 14px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--field);
      color: var(--text);
      font-size: 16px;
      outline: none;
      transition: transform 180ms ease, border-color 180ms ease, box-shadow 180ms ease;
    }

    input:focus{
      border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 22%, transparent);
    }

    .toggle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
    }
    .toggle span{ color: var(--muted); font-size: 14px; }

    .switch{
      position: relative;
      width: 46px;
      height: 28px;
      display:inline-block;
      flex: 0 0 auto;
    }
    .switch input{ display:none; }
    .slider{
      position:absolute; inset:0;
      border-radius: 999px;
      background: rgba(120,120,128,0.28);
      transition: 200ms ease;
      border: 1px solid var(--border);
    }
    .slider:before{
      content:"";
      position:absolute;
      height: 24px; width: 24px;
      left: 2px; top: 1.5px;
      border-radius: 50%;
      background: rgba(255,255,255,0.92);
      transition: 200ms cubic-bezier(.2,.8,.2,1);
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
    }
    @media (prefers-color-scheme: dark){
      .slider:before{ background: rgba(240,240,245,0.92); }
    }
    .switch input:checked + .slider{
      background: color-mix(in srgb, var(--accent) 55%, rgba(120,120,128,0.28));
      border-color: color-mix(in srgb, var(--accent) 35%, var(--border));
    }
    .switch input:checked + .slider:before{
      transform: translateX(18px);
    }

    .btn{
      width:100%;
      margin-top: 12px;
      padding: 14px 14px;
      border: none;
      border-radius: 14px;
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 92%, white 8%), var(--accent));
      color: white;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: -0.01em;
      cursor: pointer;
      transition: transform 120ms ease, filter 200ms ease;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{
      transform: scale(0.985);
      filter: brightness(0.95);
      background: var(--accentPressed);
    }

    .sectionTitle{
      margin: 14px 2px 8px 2px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 600;
      letter-spacing: 0.01em;
      text-transform: uppercase;
    }

    .result{
      position: relative;
      margin-top: 10px;
      padding: 14px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--result);
      max-height: 280px;
      overflow-y: auto;
      overflow-x: hidden;
      white-space: pre-wrap;
      overflow-wrap: break-word;
      word-break: break-word;

      /* iOS scroll smooth */
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
      transition: opacity 200ms ease, transform 200ms ease;
    }

    .result.fadeIn{
      animation: popIn 280ms cubic-bezier(.2,.8,.2,1);
    }
    @keyframes popIn{
      from { opacity: .6; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(env(safe-area-inset-bottom) + 14px);
      transform: translateX(-50%) translateY(20px);
      opacity: 0;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,0.70);
      color: white;
      font-size: 13px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      transition: 220ms cubic-bezier(.2,.8,.2,1);
      pointer-events:none;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .hidden{ display:none; }

    .adminBox{
      margin-top: 10px;
      padding: 12px;
      border-radius: 16px;
      border: 1px dashed var(--border);
      background: rgba(255,255,255,0.05);
    }
    .adminBox .btn{
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="title">
        <h1>TDFC Dico</h1>
        <div class="sub">Recherche par Imprimé + Code EDI</div>
      </div>
      <div class="pill">v1</div>
    </div>

    <div class="card">
      {% if is_admin_ui %}
        <div class="adminBox">
          <div class="sectionTitle">Admin</div>
          <input id="adminKey" placeholder="Clé admin">
          <input type="file" id="file" accept=".xlsx">
          <button class="btn" onclick="upload()">Uploader</button>
          <div id="uploadOut" class="result" style="max-height:120px;">—</div>
        </div>
      {% endif %}

      <div class="sectionTitle">Recherche</div>

      <div class="row">
        <input id="imprime" inputmode="numeric" autocomplete="off" placeholder="Imprimé">
        <input id="codeedi" autocapitalize="characters" autocomplete="off" placeholder="Code EDI">
      </div>

      <div class="toggle">
        <span>Tous les résultats</span>
        <label class="switch" aria-label="Tous les résultats">
          <input id="all" type="checkbox">
          <span class="slider"></span>
        </label>
      </div>

      <button class="btn" onclick="lookup()">Rechercher</button>

      <div class="sectionTitle">Résultat</div>
      <div id="out" class="result">—</div>
    </div>
  </div>

  <div id="toast" class="toast">—</div>

  <script>
    function showToast(msg){
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>t.classList.remove("show"), 1600);
    }

    function animateResult(el){
      el.classList.remove("fadeIn");
      void el.offsetWidth; // reflow
      el.classList.add("fadeIn");
    }

    async function upload(){
      const f = document.getElementById("file")?.files?.[0];
      const key = document.getElementById("adminKey")?.value || "";
      const out = document.getElementById("uploadOut");

      if(!f){
        out.textContent = "Choisis un fichier .xlsx";
        animateResult(out);
        showToast("Fichier manquant");
        return;
      }

      const fd = new FormData();
      fd.append("file", f);

      out.textContent = "Upload en cours…";
      animateResult(out);

      const res = await fetch("/upload?key=" + encodeURIComponent(key), { method:"POST", body:fd });
      const data = await res.json().catch(()=>({}));

      if(!res.ok){
        out.textContent = data.detail || "Erreur upload";
        animateResult(out);
        showToast("Échec upload");
        return;
      }

      out.textContent = "OK — indexation terminée. Redirection…";
      animateResult(out);
      showToast("Upload OK");
      setTimeout(()=>location.href="/", 650);
    }

    async function lookup(){
      const imprime = document.getElementById("imprime").value.trim();
      const codeedi = document.getElementById("codeedi").value.trim();
      const all = document.getElementById("all").checked;
      const out = document.getElementById("out");

      if(!imprime || !codeedi){
        out.textContent = "Veuillez renseigner Imprimé et Code EDI.";
        animateResult(out);
        showToast("Champs requis");
        return;
      }

      out.textContent = "Recherche…";
      animateResult(out);

      const qs = new URLSearchParams({ imprime, codeedi, all: String(all) });

      try{
        const res = await fetch("/lookup?" + qs.toString());
        const data = await res.json();

        if(!res.ok){
          out.textContent = data.detail || "Erreur serveur";
          animateResult(out);
          showToast("Erreur");
          return;
        }

        if(!data.found){
          out.textContent = "Non trouvé";
          animateResult(out);
          showToast("Aucun résultat");
          return;
        }

        out.textContent = data.libelle ? data.libelle : (data.libelles || []).join("\\n");
        animateResult(out);
        showToast("OK");
      }catch(e){
        out.textContent = "Erreur réseau";
        animateResult(out);
        showToast("Réseau");
      }
    }

    // Petite animation iOS au focus
    document.addEventListener("focusin", (e)=>{
      const el = e.target;
      if(el && el.tagName === "INPUT"){
        el.style.transform = "translateY(-1px)";
        setTimeout(()=>{ el.style.transform = ""; }, 220);
      }
    });
  </script>
</body>
</html>
